---
title: "STATS 451 Homework 8"
author: "Yuzhou Peng"
date: "2024-04-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rstan)
```

# Problem 1
```{r}
rat_tumour_data <- list(J = 68,
                        y = c(0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,
       2,1,5,2,5,3,2,7,7,3,3,2,9,10,4,4,4,4,4,4,4,10,4,4,4,5,
       11,12, 5,5,6,5,6,6,6,6,16,15,15,9,4),
                        n = c(20,20,20,20,20,19,19,19,19,18,17,20,20,20,20,19,19,18,18,25,24,
       23,20,20,20,20,20,20,10,49,19,46,27,17,49,47,20,20,13,48,50,20,
       20,20,20,20,20,20,48,19,19,19,22,46,49,20,20,23,19,22,20,20,20,
       52,46,47,24,14)
)

sum(rat_tumour_data$y)
sum(rat_tumour_data$n)
```

```{r}
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

```{r}
rat_tumour_fit <- stan(file = 'rat_tumour.stan', data = rat_tumour_data, 
            iter = 1000, chains = 4, core = 4)


```
# Problem 2
```{r}
print(rat_tumour_fit)
plot(rat_tumour_fit)

rat_tumour_sample <- extract(rat_tumour_fit)
```

```{r}
mean(rat_tumour_sample$gamma < 0.2)
```
We obtained samples from the target distribution.  
(1) The expected value of alpha is around 2.8.  
(2) Transformed parameter gamma corresponds to alpha/(alpha + beta). The probability of gamma is less than 0.2 is 0.99.  


# Problem 3
```{r}
theta_68 <- rat_tumour_sample$theta[,68]

hist(theta_68)
```

The posterior distribution of theta 68 is beta distribution with mean value around 0.21,  
which is smaller than single MLE estimate that yields 4/14 = 0.285 as mean value and larger than the overall  
MLE estimate which is 266/1681 = 0.16.  
The posterior from hierarchical model is a compromise between total homogeneity model and  
heterogeneity model.